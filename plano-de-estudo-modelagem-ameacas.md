## Modelagem de Amea√ßas

> ‚ö†Ô∏è **IMPORTANTE:**  
> Se voc√™ trabalha com seguran√ßa de produtos, seguran√ßa de aplica√ß√µes ou engenharia de seguran√ßa, este plano de estudos √© mais essencial para voc√™ do que para outros profissionais da √°rea. No entanto, recomenda-se que todo profissional de seguran√ßa tenha uma boa compreens√£o dos fundamentos de modelagem de amea√ßas.

![Plano de Estudos de Modelagem de Amea√ßas](images/threat_modelling.png)

> üí° **Nota:**  
> Leva cerca de 2-3 meses para adquirir um bom entendimento de Threat Modeling com alguma experi√™ncia pr√°tica.

### O que √© Modelagem de Amea√ßas

Modelagem de amea√ßas √© uma abordagem estruturada para analisar a seguran√ßa de uma aplica√ß√£o, permitindo identificar, quantificar e tratar riscos de seguran√ßa associados.  
Com detalhes sobre amea√ßas e ataques prov√°veis, a empresa pode tomar decis√µes mais eficazes sobre como priorizar iniciativas de seguran√ßa.  
Al√©m disso, as decis√µes de aceita√ß√£o de risco s√£o mais informadas e alinhadas aos objetivos do neg√≥cio.

### Ferramentas para explorar

1. [OWASP Threat Dragon](https://www.threatdragon.com/#/)
2. [Microsoft Threat Modeling Tool](https://learn.microsoft.com/en-us/azure/security/develop/threat-modeling-tool)
3. [STRIDE GPT](https://stridegpt.streamlit.app/)
4. [Threagile](https://run.threagile.io/)
5. [PyTM](https://github.com/izar/pytm)
6. [draw.io](https://www.drawio.com/)
7. [Excalidraw](https://excalidraw.com/)
8. [Iurus Risk - Ferramenta paga para automatizar modelagens](https://www.iriusrisk.com/)
9. [SD Elements - Ferramenta paga para automatizar modelagens](https://www.securitycompass.com/sdelements/)

### Recursos para aprender e praticar

1. [Threat Modeling Manifesto](https://www.threatmodelingmanifesto.org/)
2. [Artigo - O que √© modelagem de amea√ßas](https://www.simplilearn.com/what-is-threat-modeling-article)
3. [Modelagem de Amea√ßas, o primeiro passo para o Desenvolvimento Seguro de Aplica√ß√µes](https://medium.com/@fernando-silva/modelagem-de-amea√ßas-o-primeiro-passo-para-o-desenvolvimento-seguro-de-aplica√ß√µes-c33649ad856e)
4. [MITRE Cyber Threat Modeling](https://www.mitre.org/sites/default/files/2021-11/prs-18-1174-ngci-cyber-threat-modeling.pdf)
5. [Modelagem de Amea√ßas - Um guia de bolso](https://shellsharks.com/threat-modeling)
7. [Awesome Threat Modeling (GitHub)](https://github.com/hysnsec/awesome-threat-modelling)
8. [Podcast de Threat Modeling - Chris Romeo](https://open.spotify.com/show/4q9BxNrRb0NWnLBpSmNqoP)
9. [Certifica√ß√£o: Certifica√ß√£o profissional em Modelagem de Amea√ßas](https://www.practical-devsecops.com/certified-threat-modeling-professional/)
10. [Kubernetes Threat Modeling](https://www.trendmicro.com/vinfo/in/security/news/security-technology/a-deep-dive-into-kubernetes-threat-modeling)
11. [AWS S3 Threat Modeling](https://controlcatalog.trustoncloud.com/dashboard/aws/s3)

### V√≠deos

1. [Modelagem de Amea√ßas: qual o papel da pessoa desenvolvedora?](https://www.youtube.com/watch?v=-grCdXWlydw)
2. [Modelagem de amea√ßas, canvas. C√≥digo Seguro #014](https://www.youtube.com/watch?v=n6UgriY5DU0)
3. [O que √© modelagem de amea√ßas e por que √© importante?](https://youtu.be/h_BC6QMWDbA)
4. [Introdu√ß√£o a modelagem de amea√ßas](https://www.youtube.com/watch?v=GqmQg-cszw4)

### Cursos 
1. [Treinamento gratuito de Modelagem de amea√ßas da Iurus Risk](https://www.iriusrisk.com/threat-modeling-training)
2. [Treinamento gratuito da Microsoft sobre fundamentos da Modelagem de ame√ßas](https://learn.microsoft.com/pt-br/training/modules/tm-introduction-to-threat-modeling)
3. [Treinaemnto gratuito da Microsoft sobre an√°lise de fluxo de dados e STRIDE](https://learn.microsoft.com/en-us/training/paths/tm-threat-modeling-fundamentals)
4. [Curso Pago na Udemy: STRIDE - Taimur](https://www.udemy.com/course/threat-modeling-using-stride-masterclass/?couponCode=IND21PM)

### Livros

1. [Threat Modeling: A Practical Guide for Development Teams](https://a.co/d/23Bfseu)
2. [Mastering Threat Modeling A Comprehensive Guide to Identifying and Mitigating Risks](https://a.co/d/790xsbY)

> üí° **DICA:**  
> Al√©m deste material, d√™ uma revisada no [OWASP Threat Modeling Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Threat_Modeling_Cheat_Sheet.html) para entendimento b√°sico.

Em resumo:

- **Modelagem de amea√ßas √© o processo** de identificar, analisar e mitigar amea√ßas de seguran√ßa potenciais a um sistema ou organiza√ß√£o.
- Envolve identificar os ativos a serem protegidos, analisar as amea√ßas potenciais e desenvolver estrat√©gias para mitig√°-las ou elimin√°-las.
- Quanto mais cedo a modelagem for realizada, melhores os resultados, mas √© comum encontrar ambientes estabelecidos e com aplica√ß√µes em produ√ß√£o que tamb√©m pode ser necess√°rio realizar a modelagem de amea√ßas para maior entendimento da solu√ß√£o pelo engenheiro de seguran√ßa.

### Objetivos da Modelagem de Amea√ßas

1. Identificar os limites de confian√ßa do sistema
2. Reconhecer os atores que interagem dentro e fora desses limites
3. Entender os fluxos de informa√ß√£o entre os limites
4. Avaliar a persist√™ncia das informa√ß√µes dentro e fora dos limites
5. Mapear amea√ßas que transgridem os limites de confian√ßa
6. Identificar vulnerabilidades nos limites acessados por atores e nos fluxos de informa√ß√£o
7. Conhecer os agentes de amea√ßa que podem explorar essas vulnerabilidades
8. Avaliar o impacto da explora√ß√£o
9. Criar uma √°rvore de decis√£o para tratamento de riscos

## Conceitos e Termos de Modelagem de Amea√ßas

![Conceitos de Modelagem de Amea√ßas](images/mapa_mental_modelagem.png)

### Por que fazer modelagem de amea√ßas? :point_up:

+ **Identifica√ß√£o proativa de amea√ßas:** Detec√ß√£o antecipada de poss√≠veis falhas.
+ **Redu√ß√£o de Custos:** Corre√ß√µes mais baratas quando feitas no in√≠cio.
+ **Prioriza√ß√£o:** Foco nas vulnerabilidades mais cr√≠ticas.
+ **Compreens√£o do sistema:** Melhor entendimento das intera√ß√µes e fluxos de dados.

### Metodologias famosas de modelagem de amea√ßas

1. STRIDE (a mais comum)
2. CVSS (ajuda a pontuar com score os riscos identificados)
3. Lista de ataques (√∫til para o time de offensive security criar um baseline de teste daquele escopo)
4. PASTA (outra metodologia de modelagem de amea√ßas)
5. LINDDUN (foco em privacidade)

## √Åreas cobertas pela modelagem

### Ativos

Identifica√ß√£o de dados, sistemas, pessoas e hardware que precisam de prote√ß√£o.

### Amea√ßas

Identifica√ß√£o de poss√≠veis amea√ßas com base em brainstorms, relat√≥rios e especialistas.

### Probabilidade e impacto

Avalia√ß√£o de cada amea√ßa em termos de risco e impacto para prioriza√ß√£o.

### Estrat√©gias de mitiga√ß√£o

T√©cnicas para reduzir ou eliminar riscos, tanto t√©cnicas (valida√ß√£o de dom√≠nio por CSP, uso de rate_limit, valida√ß√£o de par√¢metros de entrada no backend, uso de EDR em servidores, etc) quanto n√£o t√©cnicas (treinamentos, pol√≠ticas).

### Testes e valida√ß√£o

Verifica√ß√£o da efic√°cia das estrat√©gias de mitiga√ß√£o. Normalmente crie tarefas para os times de desenvolvimento com os requisitos para ir acompanhando.

### Revis√£o e atualiza√ß√£o
 Modelos devem ser revisados periodicamente para refletir novos cen√°rios.

## üß≠ O Processo

### 1. Definir o escopo
- Observe as hist√≥rias de usu√°rio da itera√ß√£o em andamento (ou j√° desenvolvidas).
  
### 2. Criar o modelo de componentes
- Colaborativamente desenhe os componentes principais que atendem √†s hist√≥rias.
- Inclua usu√°rios e canais de comunica√ß√£o como componentes separados.

### 3. Criar diagramas de fluxo de dados
- Para cada cen√°rio (principal e de exce√ß√£o), modele como os dados fluem entre sistemas.

### 4. Identificar vulnerabilidades
- A partir dos modelos, utilize STRIDE, mapa de ataque, ou outras t√©cnicas para identificar riscos.

### 5. Analisar componentes
- Identifique os componentes novos ou com mudan√ßas significativas;
- Modele seus subcomponentes e repita o processo a partir do passo 3.

### 6. Repetir conforme necess√°rio
- Continue aprofundando at√© n√£o haver necessidade de novo detalhamento.

> üìå Este processo √© iterativo e ser√° repetido em cada nova itera√ß√£o do projeto. O modelo de amea√ßas evolui junto com o sistema.

## üõ†Ô∏è Inputs para uma boa modelagem

Os inputs que ajudam a **clarear os fluxos e intera√ß√µes** e a **gerenciar a complexidade** s√£o bem-vindas. Acione o time de arquitetura da solu√ß√£o ou desenvolvedores pr√≥ximos para obt√™-las. As mais eficazes s√£o:

- **Diagramas arquiteturais com componentes** ‚Äì mostram os sistemas em n√≠veis adequados de abstra√ß√£o;

   ![Exemplo de Modelagem de Amea√ßas](images/Diagrama_arquiteturalAWS.webp)
  
- **Diagramas de fluxo de dados (DFD)** ‚Äì representam o fluxo de dados entre componentes e sistemas.

   ![Exemplo de diagrama de fluxo de dados](images/dfd_converted.png)

> üí° **DICA:**  
> Pratique com Apache Juiceshop, WordPress na AWS, ou aplica√ß√£o com APIs e integra√ß√µes.

### Identificando amea√ßas

A modelagem de amea√ßas pode ser feita a partir de diferentes perspectivas. Para fazer esse exerc√≠cio, use o STRIDE para identificar a lista de vulnerabilidades.

- **S**poofing (falsifica√ß√£o) - Ex.: Login sem autentica√ß√£o
- **T**ampering (adultera√ß√£o) - Ex.: Altera√ß√£o de arquivos num bucket
- **R**epudation (rep√∫dio) - Ex.: Aus√™ncia de eventos e logs precisos
- **I**formation Disclosure (descoberta de informa√ß√£o) - Ex.: Dados sens√≠veis em erro 500
- **D**enial of Service (nega√ß√£o de servi√ßo) - Ex.: Overload em uma API
- **E**levate privilege (eleva√ß√£o de privil√©gio) - Ex.: Usu√°rio comum vira admin

Cada componente do sistema √© revisado, e uma lista de amea√ßas - com um mapeamento para o STRIDE - √© apresentada aqui. 

| Linha | Componente                         | Amea√ßa                                                                                  | STRIDE                      | Controle de Mitiga√ß√£o                                                                                   | Tipo de Controle | Como implementar o controle?                                                                                                                                                       |
|-------|------------------------------------|-----------------------------------------------------------------------------------------|-----------------------------|---------------------------------------------------------------------------------------------------------|------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1     | Servi√ßo de Notifica√ß√£o             | Um invasor falsifica a identidade de um componente e envia mensagens em seu nome              | Falsifica√ß√£o (Spoofing)     | Assinatura das mensagens pelo componente                                                                    | Preventivo       | O servi√ßo de notifica√ß√£o assina as mensagens antes de public√°-las na fila. Verificar a autenticidade do remetente deve ser feito antes de consumir as mensagens.                     |
| 2     | Comunica√ß√£o entre componentes         | Um invasor intercepta uma mensagem no meio do caminho e altera seu conte√∫do            | Adultera√ß√£o     | Assinatura das mensagens pelo componente                                                                   | Preventivo       | O componente assina as mensagens antes de public√°-las na fila. As assinaturas devem ser verificadas antes do consumo da mensagem para garantir que n√£o houve altera√ß√£o.                     |
| 3     | Componente SaaS-A                             | O servi√ßo nega ter enviado uma determinada mensagem                                     | Rep√∫dio                     | Assinatura das mensagens pelo componente                                                                 | Preventivo       | -                                                                                                                                                                                    |
| 4     | Comunica√ß√£o SaaS-a com servi√ßo de gerenciamento de filas           | Um invasor intercepta e l√™ as mensagens                                                 | Divulga√ß√£o de informa√ß√µes   | Permitir apenas conex√µes criptografadas via TLS                                                         | Preventivo       | Adicionar uma condi√ß√£o na pol√≠tica do recurso SQS para exigir TLS                                                                                                                   |
| 5     | SQS - Servi√ßo de gerenciamento de filas Amazon                                | O servi√ßo de notifica√ß√£o remove a fila do SQS                                           | Nega√ß√£o de Servi√ßo (DoS)    | Pol√≠ticas baseadas em recursos do SQS restringem a fun√ß√£o IAM do servi√ßo de notifica√ß√£o a enviar mensagens apenas para a fila SQS              | Preventivo       | Implementa√ß√£o da pol√≠tica baseada em recurso do SQS                                                                                                                                 |
| 6     | SQS - Servi√ßo de gerenciamento de filas Amazon                                   | Um invasor pode obter acesso apenas leitura e ler dados pessoais da fila               | Divulga√ß√£o de informa√ß√µes   | Pol√≠ticas baseadas em recurso do SQS restringem o acesso a uma conta IAM espec√≠fica do SaaS-a                                                | Preventivo       | Implementa√ß√£o da pol√≠tica baseada em recurso do SQS                                                                                                                                 |
|       |                                     |                                                                                         | Divulga√ß√£o de informa√ß√µes   | Criptografar as mensagens em repouso                                                                    | Preventivo       | Ativar SSE (Server-Side Encryption) para o SQS e garantir que n√£o haja dados pessoais nos atributos das mensagens (SQS n√£o criptografa atributos).                                  |
| 7     | KMS                                 | O servi√ßo de notifica√ß√£o chama o KMS diretamente e descriptografa mensagens             | Divulga√ß√£o de informa√ß√µes   | A chamada √† API Decrypt no servi√ßo KMS deve ser permitida apenas se a requisi√ß√£o vier via SQS (condi√ß√£o na pol√≠tica da chave CMK)             | Preventivo       | Adicionar condi√ß√£o na pol√≠tica da chave KMS para impor essa regra                                                                                                                   |
| 8     | Comunica√ß√£o SaaS-a com SQS         | Um invasor injeta dados maliciosos na fila SQS causando comportamento inesperado        | Eleva√ß√£o de privil√©gio      | Assinatura das mensagens pelo SaaS-a                                                                    | Preventivo       | SaaS-a assina as mensagens antes de public√°-las na fila. Verificar a integridade da mensagem antes de consumi-la.                                                                   |
| 9     | KMS                                 | Desenvolvedor/engenheiro de plataforma pode alterar pol√≠ticas da chave e descriptografar mensagens | Viola√ß√£o de integridade     | Todas as mudan√ßas no ambiente de produ√ß√£o devem passar por solicita√ß√£o de mudan√ßa e revis√£o por pares                                         | Preventivo       | Definir um processo de Change Request para o ambiente de produ√ß√£o                                                                                                                   |
|       |                                     |                                                                                         | Viola√ß√£o de integridade     | Monitoramento de atividades privilegiadas                                                               | Detetivo         | Definir casos de uso de monitoramento                                                                                                                                                |
| 10    | SQS - Servi√ßo de gerenciamento de filas Amazon                           | Desenvolvedor/engenheiro de plataforma pode alterar pol√≠ticas do SQS e liberar acesso a publicadores n√£o autorizados | Viola√ß√£o de integridade     | Todas as mudan√ßas no ambiente de produ√ß√£o devem passar por solicita√ß√£o de mudan√ßa e revis√£o por pares                                         | Preventivo       | Definir um processo de Change Request para o ambiente de produ√ß√£o                                                                                                                   |
|       |                                     |                                                                                         | Viola√ß√£o de integridade     | Monitoramento de atividades privilegiadas                                                               | Detetivo         | Definir casos de uso de monitoramento                                                                                                                                                |
| 11    | Servi√ßo de Notifica√ß√£o             | O servi√ßo envia notifica√ß√µes de eventos que n√£o foram iniciados pelo microservi√ßo-3     | -                           | Verificar a refer√™ncia da mensagem recebida com o evento iniciado                                       | Preventivo       | Verifica√ß√£o deve ser feita para garantir que a mensagem recebida perten√ßa a um evento iniciado pelo microservi√ßo-3                                                                 |

Ap√≥s identificar as amea√ßas, precisamos projetar o controle para mitigar o risco - e aceitar o risco residual - caso ele n√£o fosse inicialmente aceit√°vel. √â fundamental n√£o parar por a√≠ e produzir os detalhes em n√≠vel de c√≥digo para implementar os controles.

#### Resultados esperados

+ **Diagramas de Sistema:** Ilustra√ß√µes completas da arquitetura e fluxos.
+ **Requisitos de Seguran√ßa:** Crit√©rios para proteger o sistema.
+ **Lista de Amea√ßas:** Amea√ßas com suas estrat√©gias de mitiga√ß√£o.
+ **Demonstra√ß√£o da explora√ß√£o:** Demosntra√ß√£o realizada atrav√©s de pentest da explorabilidade do risco (quando aplic√°vel).

## üìà Evolu√ß√£o Cont√≠nua

A cada itera√ß√£o com novas hist√≥rias de usu√°rio:
- O modelo de amea√ßas ser√° atualizado;
- A maturidade da seguran√ßa aumenta;
- A visibilidade sobre os riscos do sistema se amplia.

### Pr√≥ximos passos

Ap√≥s entender e praticar:

1. Como aplicar modelagem no SDLC existente?
2. Como usar a IA para construir uma modelagem de amea√ßas (Stride GPT)?
3. Quais os desafios t√©cnicos esperados?
4. Como torn√°-la escal√°vel?
5. Como lidar com diferentes tipos de aplica√ß√£o?
6. Qual metodologia adotar na sua organiza√ß√£o?
7. Como validar os achados?
8. Conhe√ßa e aplique:
   - modelagem de amea√ßas √°gil
   - modelagem automatizada
   - modelagem r√°pida
   - modelagem avan√ßada
